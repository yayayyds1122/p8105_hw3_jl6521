---
title: "p8105_hw3_jl6521"
author: "Jiayi"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(dplyr)
library(p8105.datasets)
library(knitr)
library(ggridges)
```

## Problem 1
1. data cleaning
```{r description}
data("ny_noaa")
size = nrow(ny_noaa)
column = ncol(ny_noaa)
cleaned_noaa = ny_noaa %>% 
  separate(date, into = c("year","month","day"), sep="-") 
```
Description of the dataset: the dataset consists of records from `r size` weather stations around the world with `r column` daily variables. They are ids, maximum and minimum temperature, total daily precipitation, snowfall, and snow depth.

Below we clean the data, creating separate variables for year, month,
and day and converting `tmax` and `tmin` to numeric. We find that 0 is
the most commonly observed value for snowfall. This is because most days
of the year, it does not snow at all in NY. The second most commonly
observed value is `NA`, indicating missingness. Other common values are
13, 25, and 51, suggesting that snowfall is originally recorded in
fractions of an inch and converted to mm.

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))
```

```{r}
ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```
Below is a two-panel plot showing the average max temperature in January
and in July in each station across years. As expected, the mean
temperature in January is much lower than the mean temperature in July
for all stations and across all years. All stations appear to follow
similar trends of temperature peaks and valleys within a month across
the years, i.e.when one station has a high monthly mean temperature for
a given year, most other stations also have a high monthly mean
temperature for that year. We do see one uncharacteristically cold
station in July of 1987 or 1988, as well as a few other less drastic
outliers.
```{r}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```
Below we show a two-panel plot including (i) a hex plot of `tmax` vs
`tmin` for the full dataset; and (ii) a ridge plot showing the
distribution of snowfall values (in mm) greater than 0 and less than 100
separately by year.

From the hex plot we see that while there is some variability, the
majority of the data cluster tightly in the center of the distribution.
In relatively rare cases, it seems that `tmax` is less than `tmin`,
which raises questions about data recording and quality.

From the ridge plot, we see a multimodal density of snowfall within a
given year. Most stations see between 0 and 35 mm of snow in a year.
Then there is a another group of stations that see about 45 mm of snow,
and another group that sees nearly 80 mm. It is likely this
multimodality stems from the conversion of measurements in one system
(fractions of an inch) to another (using the metric system), which was
also noted in the table of common values.
```{r}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

```




## Problem 2
1. Table cleaning and binding  
```{r merged table}
acc_data = read_csv("./data/nhanes_accel.csv",
                    na = c("NA", ".", ""),show_col_types = FALSE
                    ) %>% 
  janitor::clean_names()

demo_data = read_csv("./data/nhanes_covar.csv",
                     skip = 4,
                     na = c("NA", ".", ""),show_col_types = FALSE
                     ) %>% 
  janitor::clean_names()

merged_mims = inner_join(demo_data,acc_data, by = "seqn") %>%
  filter(age >= 21) %>%
  drop_na(sex, age, bmi, education) %>%
  mutate(sex = factor(sex,
         levels = c(1,2),
         labels = c("male", "female"))
         ) %>% 
  mutate(education = factor(education,
         levels = c(1,2,3),
         labels = c("Less than high school", 
                    "High school equivalent",
                    "More than high school")))
```

2. Table for education and number of men and women in each education category
```{r table}
education_table = merged_mims %>% 
  group_by(education,sex) %>% 
  summarize(
    number = n(),
    .groups = 'drop'
  ) %>% 
  pivot_wider(
    names_from = sex,
    values_from = number
  )  
education_table %>% 
  kable(
    col.names = c("Education level", "Female", "Male"),
    caption = "Number of Men and Women by Education Category",
    align = "c",
    caption.position = "top"
  )
```

3. Age distribution visualization 
```{r age visualization}
education_visualization = ggplot(merged_mims,aes(x=age, fill = sex)) + 
  geom_density(alpha = 0.31) + 
  facet_grid(.~education)+
  labs(
    title = "Age Distribution by Education and Sex",
    x = "age",
    y = "Density"
  ) + 
  theme_minimal()

print(education_visualization)
```
Comment: From the plot, we can see that the age of the people with more than high school degree is usually lower than the other two education levels. The age of males and females are similar for both less than high school group and more than high school group, but not the high school equivalent group. In the high school equivalent group, the age of females is higher htan the males. 

4. Total activity against age for education levels 
```{r aggregate activity}
agg_data =
  merged_mims %>% 
  mutate(
    total_activity = rowSums(across(starts_with("min")),na.rm = TRUE)
  )%>%
  select(seqn,sex,age,bmi,education,total_activity,everything())

agg_visualization = agg_data %>% 
  ggplot(aes(x=age,y=total_activity,color = sex))+
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_grid(. ~ education) + 
  labs(
    title = "Total Activities against age",
    y = "total activity"
  )+
  theme_minimal()

print(agg_visualization)

```
Comment: 
For the less than high school group, the total activity of males and females decrease as age increase, except for a peak around age 60 when the total activities of two group increase from 45 to 60. Before 40 years old, the total activity of females are larger than of males, but after 40 years old, total activities for males are larger than females. 
For the high school equivalent group, the total activity increase at first when age is small and then decreases as females and male get older. For females, there's an small increase again at later age but not for males. Generally females have higher total activity than males except for the initial time. 
For the more than high school group, the total activity of females is larger than the males all the time.

5. Three-panels plot for time courses for each education level
```{r}
time_plot = merged_mims %>% 
  pivot_longer(
    cols = min1:min1440,
    names_to = "time",
    values_to = "activity"
  ) %>% 
  #group_by(education, sex, time) %>% 
  #summarize(mean_activity = mean(activity, na.rm = TRUE),.groups = 'drop') %>%
  mutate(time = as.numeric(gsub("min", "", time))) %>%
  ggplot(aes(x=time,y=activity,group = seqn,color = sex))+
  geom_line(alpha = 0.5) +
  geom_smooth(aes(group = sex), se = FALSE)+
  facet_grid(. ~ education) + 
  labs(
    title = "Activity over time for different education levels for males/females",
    x = "time (minute)",
    y = "activity"
  ) +
  theme(legend.position = "bottom")
print(time_plot)
```
Comment: Three panel graphs have similar trends overall where they all decrease at first and then increase starting from 250 minutes (around 4am). 
For the group with less than high school education, people's average activity peaks at similar time (750 min) for both females and males. 

For the group with high school equivalent degree, most of the time, the mean time of activity of females are larger than males. For males, the time plot is relatively stable then females over the period of 750 min to 1125 min.

For the group with more than high school degree, females have higher and more stable activity during the 500 min to 1125 min while males activity plot fluctuates a lot during that time.  

## Problem 3
1. Data import and cleaning
```{r data_import}
jan20 = read_csv("./data/citibike/Jan 2020 Citi.csv",
                    na = c("NA", ".", ""), show_col_types = FALSE)%>% 
  janitor::clean_names() %>% 
  mutate(
    month = "Janurary",
    year = "2020"
  )
jan24 = read_csv("./data/citibike/Jan 2024 Citi.csv",
                    na = c("NA", ".", ""),show_col_types = FALSE)%>% 
  janitor::clean_names() %>% 
  mutate(
    month = "Janurary",
    year = "2024"
  )
july20 = read_csv("./data/citibike/July 2020 Citi.csv",
                    na = c("NA", ".", ""),show_col_types = FALSE)%>% 
  janitor::clean_names()%>% 
  mutate(
    month = "July",
    year = "2020"
  )
july24 = read_csv("./data/citibike/July 2024 Citi.csv",
                    na = c("NA", ".", ""),show_col_types = FALSE)%>% 
  janitor::clean_names()%>% 
  mutate(
    month = "July",
    year = "2024"
  )

df_total = rbind(jan20,jan24,july20,july24)
```
Description: the full dataset records the ride ID, ride type, the day of the week, the month and the year of the ride, duration of the ride, start and end station time, and also if it's citi bike member or casual riders.

2. Table for total number of rides for causal and mem